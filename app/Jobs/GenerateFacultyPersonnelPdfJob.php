<?php

namespace App\Jobs;

use Barryvdh\DomPDF\Facade\Pdf;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\Log;

class GenerateFacultyPersonnelPdfJob implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    /**
     * Create a new job instance.
     */
    public function __construct()
    {
        //
    }

    /**
     * Execute the job.
     */
    public function handle()
    {
        $faculty = [
            '661051758',
            '650310238',
            '651482269',
            '650254810',
            '665494381',
            '667080360',
            '674342835',
            '651443536',
            '660988250',
            '663188782',
            '656800883',
            '674549012',
            '651992127',
            '669494806',
            '668450235',
            '658034130',
            '663050936',
            '672871876',
            '665479458',
            '659492757',
            '675731245',
            '650623849',
            '650835560',
            '670362753',
            '657499300',
            '673089929',
            '657686139',
            '654626734',
            '679242604',
            '676940858',
            '663303843',
            '669097680',
            '660175308',
            '653359768',
            '667252958',
            '660626245',
            '671686235',
            '655649695',
            '673565613',
            '665920863',
            '673952190',
            '676587542',
            '669478281',
            '676342649',
            '671282917',
            '662840838',
            '655085838',
            '661122396',
            '657459797',
            '660545773',
            '662050752',
            '653814506',
            '672358717',
            '665554362',
            '652200845',
            '668978002',
            '650218942',
            '655313952',
            '661974968',
            '669833657',
            '658448091',
            '667014552',
            '657946079',
            '665046183',
            '677509509',
            '667720517',
            '662098410',
            '654685827',
            '668090767',
            '656858397',
            '651017092',
            '663561592',
            '651656267',
            '663560922',
            '677057028',
            '658733981',
            '663347596',
            '653108478',
            '674088792',
            '660121797',
            '651070281',
            '668500171',
            '662978905',
            '661156918',
            '669580804',
            '674347443',
            '667545455',
            '675022467',
            '663750947',
            '658514221',
            '670084568',
            '669242653',
            '663311124',
            '668956252',
            '663776302',
            '678939238',
            '665359518',
            '651929232',
            '665063238',
            '673419754',
            '658674790',
            '662222260',
            '668606721',
            '679065327',
            '673228250',
            '661346359',
            '659090052',
            '666694432',
            '668233505',
            '657976427',
            '651709303',
            '653747527',
            '667988221',
            '653046685',
            '675373667',
            '661610224',
            '662062821',
            '662308728',
            '668765561',
            '656161964',
            '654814371',
            '656533542',
            '665158818',
            '662314648',
            '670198964',
            '664608793',
            '654214826',
            '654958192',
            '660601729',
            '670526172',
            '660811659',
            '664876445',
            '661829005',
            '668296946',
            '670525004',
            '651224956',
            '666002251',
            '670770267',
            '669946613',
            '660395928',
            '667334453',
            '657194673',
            '662811092',
            '674016452',
            '670213455',
            '668606004',
            '664628645',
            '674271147',
            '660462686',
            '666175117',
            '668729890',
            '663569483',
            '673873017',
            '657031359',
            '659314812',
            '669867855',
            '675357890',
            '662790739',
            '652868368',
            '668940408',
            '674356112',
            '663756807',
            '676378891',
            '660345622',
            '673993046',
            '661974345',
            '660383737',
            '663173237',
            '652879008',
            '671743011',
            '663329094',
            '652940720',
            '679284272',
            '660012747',
            '677574046',
            '662977147',
            '677487903',
            '676567875',
            '674604960',
            '678586590',
            '653192572',
            '663958412',
            '658489943',
            '667083431',
            '660540603',
            '656196415',
            '675065916',
            '658906079',
            '661564215',
            '677779195',
            '676921860',
            '666039375',
            '668292629',
            '665296219',
            '669171239',
            '666065220',
            '678290685',
            '660997723',
            '653074598',
            '662639644',
            '666564078',
            '669861439',
            '651605579',
            '653249288',
            '659802032',
            '651121885',
            '668738703',
            '668413132',
            '669243763',
            '658434251',
            '651456395',
            '659170924',
            '666006549',
            '671467077',
            '654305574',
            '651484280',
            '674690789',
            '670709260',
            '655178267',
            '650255980',
            '650951768',
            '656925360',
            '651972248',
            '663485137',
            '674831695',
            '656708706',
            '673901668',
            '678667700',
            '665472022',
            '659438910',
            '659831196',
            '670195903',
            '679457014',
            '659624632',
            '667269890',
            '650106876',
            '660698273',
            '664201481',
            '673055030',
            '669038573',
            '658087137',
            '658838609',
            '661957611',
            '665968217',
            '679239634',
            '674023725',
            '658150700',
            '672677451',
            '672985870',
            '661370320',
            '651420907',
            '658396900',
            '652771089',
            '661903702',
            '664335452',
            '663509486',
            '653553417',
            '662542777',
            '657848273',
            '667582993',
            '679073160',
            '668532103',
            '675908383',
            '669673378',
            '658591176',
            '651337226',
            '679935979',
            '654581927',
            '669757882',
            '678041478',
            '668701070',
            '656911133',
            '000000147',
            '650788709',
            '670213392',
            '667527192',
            '656306121',
            '654860392',
            '656857986',
            '655865685',
            '656086705',
            '650527861',
            '666051655',
            '651410860',
            '677249618',
            '664130241',
            '671922783',
            '658004870',
            '669822585',
            '672342332',
            '674090634',
            '654106298',
            '664628634',
            '654735786',
            '654306850',
            '654942434',
            '675102932',
            '659494636',
            '664946885',
            '679373836',
            '655246599',
            '667606914',
            '674918519',
            '667324516',
            '660729543',
            '657492442',
            '674893069',
            '661229357',
            '671665186',
            '655069732',
            '672469822',
            '669409135',
            '650613259',
            '661757256',
            '674793209',
            '674826802',
            '650356761',
            '667970529',
            '663117934',
            '664675757',
            '675294399',
            '654599129',
            '662877332',
            '664709878',
            '652380006',
            '670110892',
            '667661762',
            '673550082',
            '661706236',
            '674886426',
            '668326257',
            '668413634',
            '665887631',
            '661302249',
            '669444337',
            '669966666',
            '661983198',
            '669617691',
            '667870396',
            '660644860',
            '674393275',
            '655659765',
            '662722858',
            '662290360',
            '672983389',
            '656057011',
            '668123444',
            '665579919',
            '666836128',
            '662944144',
            '679744582',
            '651176039',
            '654410690',
            '674466691',
            '652340728',
            '652470951',
            '663037493',
            '654209348',
            '667283018',
            '655664028',
            '658394777',
            '654997242',
            '660272925',
            '667335950',
            '678686199',
            '663837370',
            '664640311',
            '660642777',
            '668491783',
            '666168708',
            '662456840',
            '660592764',
            '661749792',
            '663969187',
            '662130087',
            '669512155',
            '662907862',
            '665154621',
            '674719245',
            '660576282',
            '661939031',
            '660328108',
            '659713639',
            '652186775',
            '674595562',
            '679183988',
            '665319688',
            '669829795',
            '671578274',
            '664772206',
            '662266796',
            '657214737',
            '668315395',
            '673994305',
            '667281485',
            '676902737',
            '655241557',
            '676727017',
            '676443934',
            '662232942',
            '675512814',
            '661876046',
            '658658809',
            '653079392',
            '668319798',
            '656834190',
            '664109351',
            '662363261',
            '657143629',
            '656627813',
            '662879700',
            '679134448',
            '672509925',
            '662289442',
            '663993767',
            '659568782',
            '664111424',
            '658704425',
            '671016833',
            '654953562',
            '661586933',
            '667605551',
            '652909349',
            '667955049',
            '663551566',
            '664729647',
            '667303614',
            '665147816',
            '650600588',
            '672302778',
            '664500916',
            '670700173',
            '664616980',
            '664810074',
            '669058509',
            '650990408',
            '663939791',
            '657509618',
            '675140367',
            '655108854',
            '657560778',
            '650608827',
            '661994765',
            '668520136',
            '679144807',
            '657828937',
            '655869258',
            '656856093',
            '677536810',
            '661179213',
            '662620211',
            '651436673',
            '667710432',
            '664780288',
            '665871957',
            '667945384',
            '659505820',
            '656234229',
            '664949736',
            '671402824',
            '667881030',
            '661865196',
            '671570836',
            '664946626',
            '654119034',
            '663926831',
            '669799620',
            '676521644',
            '659280961',
            '663793103',
            '651492734',
            '650014609',
            '657281064',
            '662814769',
            '650277296',
            '663674274',
            '657410142',
            '674574814',
            '655306833',
            '679067379',
            '667472339',
            '664559518',
            '654789787',
            '000000323',
            '676303930',
            '668119875',
            '671720217',
            '674409000',
            '671633656',
            '674877274',
            '667049064',
            '676386549',
            '651437888',
            '651122126',
            '657018893',
            '657310498',
            '668799796',
            '660598356',
            '655428000',
            '665235119',
            '664092147',
            '676592012',
            '665876834',
            '674183247',
            '655872741',
            '678473677',
            '670381029',
            '665025941',
            '668606772',
            '653928976',
            '677253821',
            '657833571',
            '666510373',
            '658862129',
            '653076809',
            '657338126',
            '661241871',
            '673882766',
            '662802452',
            '674936788',
            '669682082',
            '677950792',
            '664391509',
            '660537342',
            '653930467',
            '650986366',
            '671217035',
            '650546588',
            '661784264',
            '673413110',
            '660616228',
            '654994111',
            '662283902',
            '661019260',
            '659717538',
            '652001364',
            '677031208',
            '670893887',
            '667566808',
            '668217795',
            '670574574',
            '663556074',
            '668634412',
            '660181453',
            '658465977',
            '663139357',
            '663259681',
            '671485997',
            '666356437',
            '678520927',
            '662972155',
            '651734684',
            '672357743',
            '664918070',
            '679351256',
            '657997080',
            '668374357',
            '675953752',
            '662331527',
            '667475416',
            '663303368',
            '662629852',
            '670823546',
            '671975381',
            '664899007',
            '673615284',
            '655725054',
            '657110917',
            '672111501',
            '662514575',
            '660231518',
            '651800444',
            '665447564',
            '661711092',
            '664706994',
            '660226220',
            '660940718',
            '676991044',
            '668728709',
            '673321629',
            '653991646',
            '665712385',
            '666463969',
            '678031543',
            '676189072',
            '664149468',
            '660902738',
            '664044342',
            '668503531',
            '668847447',
            '665155506',
            '670452905',
            '653111684',
            '669241690',
            '665644152',
            '669696864',
            '660437303',
            '669753967',
            '660205348',
            '669679460',
            '658250397',
            '671122637',
            '653493434',
            '661624720',
            '651403595',
            '669991643',
            '651086160',
            '663949953',
            '650872491',
            '668798189',
            '667074279',
            '668620471',
            '668036984',
            '658114492',
            '666473738',
            '669233689',
            '668435073',
            '668723800',
            '675101603',
            '661437420',
            '667814257',
            '673169730',
            '659042990',
            '650688396',
            '651375411',
            '667127439',
            '677610120',
            '667563421',
            '662634945',
            '654867541',
            '659258068',
            '665599398',
            '675860420',
            '661891660',
            '672094391',
            '652950575',
            '669558583',
            '669371305',
            '669574878',
            '676914721',
            '665691043',
            '660839239',
            '657890549',
            '661992007',
            '661589779',
            '658292346',
            '671517943',
            '672619623',
            '658714051',
            '668328798',
            '669018710',
            '653114689',
            '665603694',
            '652159449',
            '661192858',
            '662745750',
            '657457445',
            '651548782',
            '664133953',
            '652782671',
            '652233812',
            '679307525',
            '677902928',
            '670332086',
            '653738366',
            '669326474',
            '664019879',
            '664478726',
            '655558457'
        ];
        $evaluations = DB::connection('reporting')
            ->table('REPORT_XLISTED')
            ->select(
                "COURSE_NO", "SEMESTER", "UIN", "STUDENT_ID", "INSTRUCTOR", "ANSWER_01", "ANSWER_02", "ANSWER_03", "ANSWER_04",
                "ANSWER_05", "ANSWER_06", "ANSWER_07", "ANSWER_08", "ANSWER_09", "ANSWER_10", "COURSE_LEVEL", "COURSE_AREA_CODE", "COURSE_DIVISION",
                "COLLEGE", "DEPARTMENT", "SEMESTER_DESC", "FACULTY_GENDER", "EVALMODE"
            )
            ->where('semester', '=', '20233')
            ->whereIn('uin', $faculty)
            ->groupBy(
                "COURSE_NO", "SEMESTER", "UIN", "STUDENT_ID", "INSTRUCTOR", "ANSWER_01", "ANSWER_02", "ANSWER_03", "ANSWER_04",
                "ANSWER_05", "ANSWER_06", "ANSWER_07", "ANSWER_08", "ANSWER_09", "ANSWER_10", "COURSE_LEVEL", "COURSE_AREA_CODE", "COURSE_DIVISION",
                "COLLEGE", "DEPARTMENT", "SEMESTER_DESC", "FACULTY_GENDER", "EVALMODE"
            )
            ->orderBy('student_id')
            ->get();
        $evaluations = $evaluations->groupBy(['uin', 'course_no']);
        $evaluations->each(function ($course, $instructorUin) {
            $course->each(function ($evaluations, $courseNo) use ($instructorUin) {
                try {
                    $semesterDesc = $evaluations->first()?->semester_desc;
                    $fullFilePath = storage_path('app/pdfs/faculty-personnel/' . $semesterDesc . '/' . $instructorUin . '-' . $courseNo . '-' . $semesterDesc . '.pdf');
                    if(!File::isDirectory(storage_path('app/pdfs/faculty-personnel/' . $semesterDesc ))) {
                        File::makeDirectory(storage_path('app/pdfs/faculty-personnel/' . $semesterDesc ));
                    }
                    if (!File::exists($fullFilePath)) {
                        $pdf = PDF::loadView('pdf.faculty-personnel.show', [
                            'evaluations' => $evaluations,
                            'totalCount' => $evaluations->count(),
                            'instructor' => $evaluations->first()?->instructor,
                            'courseNo' => $courseNo,
                            'semesterDesc' => $semesterDesc,
                        ]);
                        $pdf->setOption('javascript-delay', 5000);
                        $pdf->setOption('enable-smart-shrinking', true);
                        $pdf->setOption('grayscale', true);
                        $pdf->setOption('no-stop-slow-scripts', true);
                        $pdf->setOption('orientation', 'portrait');
                        $pdf->setPaper('letter');
                        $pdf->save($fullFilePath);
                    }
                } catch (\Exception $exception) {
                    Log::info("Failed to generate PDF for: {$evaluations->first()?->student_id}");
                    throw $exception;
                }
            });
        });
    }
}
